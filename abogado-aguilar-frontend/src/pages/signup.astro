---
 // Página de registro para crear un nuevo sitio y usuario de administración.
 // Aquí el visitante podrá proporcionar un identificador para su nueva página,
 // junto con su información de contacto y unas credenciales. El formulario
 // enviará los datos al backend mediante una solicitud HTTP POST. Se asume
 // que el backend expone un endpoint `/api/auth/signup` que acepta un cuerpo
 // JSON con `siteId`, `fullName`, `email`, `password`, `headline` y
 // `description` para crear el usuario y el contenido base.

 import "../styles/global.css";

 const title = "Registro – Crear nueva página";
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{title}</title>
  </head>
  <body class="bg-white text-gray-900">
    <main class="container mx-auto px-4 py-8 max-w-xl">
      <h1 class="text-3xl font-bold mb-4">Crea tu página</h1>
      <p class="mb-6">
        Para crear una nueva página necesitas elegir un identificador único y proporcionar
        tus datos de contacto. El identificador formará parte de la URL pública de tu sitio.
      </p>
      <form id="signup-form" class="space-y-4">
        <div>
          <label for="siteId" class="block font-medium mb-1">Identificador del sitio</label>
          <input
            id="siteId"
            name="siteId"
            type="text"
            required
            pattern="^[A-Za-z0-9\\-]+$"
            title="Utiliza letras, números o guiones"
            placeholder="Ej.: bufete-abogado (solo letras, números y guiones)"
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label for="fullName" class="block font-medium mb-1">Nombre completo</label>
          <input
            id="fullName"
            name="fullName"
            type="text"
            required
            placeholder="Nombre y apellidos"
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label for="email" class="block font-medium mb-1">Correo electrónico</label>
          <input
            id="email"
            name="email"
            type="email"
            required
            placeholder="ejemplo@dominio.com"
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label for="password" class="block font-medium mb-1">Contraseña</label>
          <input
            id="password"
            name="password"
            type="password"
            minlength="6"
            required
            placeholder="Al menos 6 caracteres"
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label for="headline" class="block font-medium mb-1">Titular (opcional)</label>
          <input
            id="headline"
            name="headline"
            type="text"
            placeholder="Frase corta opcional"
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label for="description" class="block font-medium mb-1">Descripción breve (opcional)</label>
          <textarea
            id="description"
            name="description"
            rows="3"
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Descripción breve de tu página (opcional)"></textarea>
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded"
        >
          Crear página
        </button>
      </form>
      <p id="signup-message" class="mt-4 text-sm"></p>
    </main>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Asegura que 'form' sea un HTMLFormElement
        const form = document.getElementById('signup-form') as HTMLFormElement | null;
        const messageEl = document.getElementById('signup-message') as HTMLElement | null;
        if (!form || !messageEl) return;

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          messageEl.textContent = '';

          // Valida los campos obligatorios con tipos específicos
          const inputs: Array<{ el: HTMLInputElement | HTMLTextAreaElement; name: string }> = [
            { el: form.querySelector<HTMLInputElement>('#siteId')!, name: 'Identificador del sitio' },
            { el: form.querySelector<HTMLInputElement>('#fullName')!, name: 'Nombre completo' },
            { el: form.querySelector<HTMLInputElement>('#email')!, name: 'Correo electrónico' },
            { el: form.querySelector<HTMLInputElement>('#password')!, name: 'Contraseña' },
          ];

          const submitBtn = form.querySelector<HTMLButtonElement>('button[type="submit"]');
          for (const field of inputs) {
            if (!field.el || !field.el.checkValidity()) {
              messageEl.classList.remove('text-green-600');
              messageEl.classList.add('text-red-600');
              messageEl.textContent = `El campo ${field.name} tiene un formato incorrecto, corrígelo antes de continuar.`;
              if (submitBtn) {
                submitBtn.disabled = true;
                setTimeout(() => { submitBtn.disabled = false; }, 5000);
              }
              // Llama al validador nativo para mostrar el mensaje en el campo
              (field.el as any).reportValidity?.();
              return;
            }
          }

          // Prepara el payload
          const formData = new FormData(form);
          const payload = {
            siteId: formData.get('siteId'),
            fullName: formData.get('fullName'),
            email: formData.get('email'),
            password: formData.get('password'),
            headline: formData.get('headline'),
            description: formData.get('description'),
          };

          try {
            const API_BASE = import.meta.env.PUBLIC_API_BASE ?? "";
            const response = await fetch(`${API_BASE}/api/auth/signup`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (response.ok) {
              // Autologin: intenta iniciar sesión con las mismas credenciales
              try {
                const loginRes = await fetch(`${API_BASE}/api/auth/login`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ email: payload.email, password: payload.password }),
                });
                if (loginRes.ok) {
                  const { token } = await loginRes.json();
                  localStorage.setItem('authToken', token);
                } else {
                  // Si el login fallara, podrías decidir no almacenar el token y mostrar un aviso
                }
              } catch (err) {
                // Manejo de error opcional del login
              }

              // Muestra mensaje y prepara la redirección
              messageEl.classList.remove('text-red-600');
              messageEl.classList.add('text-green-600');
              messageEl.textContent = 'Registro exitoso. Redirigiendo a tu panel...';

              form.reset();
              const newSiteId = payload.siteId;

              setTimeout(() => {
                window.location.href = `/admin?site=${encodeURIComponent(String(newSiteId))}`;
              }, 2000); // 2 segundos para que el usuario alcance a ver el mensaje
            } else {
              const errorText = await response.text();
              messageEl.classList.remove('text-green-600');
              messageEl.classList.add('text-red-600');
              messageEl.textContent = 'Error al registrar: ' + errorText;
            }
          } catch {
            messageEl.classList.remove('text-green-600');
            messageEl.classList.add('text-red-600');
            messageEl.textContent = 'Error de conexión con el servidor. Inténtalo más tarde.';
          }
        });
      });
    </script>
  </body>
</html>
