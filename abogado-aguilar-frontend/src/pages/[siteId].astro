---
export const prerender = false;

import "../styles/global.css";
import { fetchContent, primaryCssVars } from "../lib/api";
import type { SiteContent } from "../types";

const { siteId } = Astro.params;
const id = String(siteId ?? "");

// Trae el contenido del sitio; si no existe -> /404
let content: SiteContent | null = null;
try {
  content = await fetchContent(id);

  // Tu fetchContent en 404 puede devolver {} (según tu lib/api.ts)
  if (!content || (typeof content === "object" && Object.keys(content as any).length === 0)) {
    return Astro.redirect("/404");
  }
} catch {
  return Astro.redirect("/404");
}

const title = content?.profile?.fullName ?? id;
const description = content?.seo?.description ?? "";

// Tema (opcional)
const cssVars =
  content?.theme?.colors ? primaryCssVars(content.theme.colors) : ({} as Record<string, string>);

function isRecord(v: unknown): v is Record<string, unknown> {
  return !!v && typeof v === "object" && !Array.isArray(v);
}

function prettyKey(k: string) {
  // profile.fullName -> Profile Full Name
  const spaced = k
    .replace(/[_\-]/g, " ")
    .replace(/([a-z])([A-Z])/g, "$1 $2")
    .trim();
  return spaced.charAt(0).toUpperCase() + spaced.slice(1);
}

function renderValue(value: unknown, path: string) {
  // Arrays
  if (Array.isArray(value)) {
    if (value.length === 0) {
      return <span class="text-gray-400">[]</span>;
    }
    return (
      <div class="space-y-3">
        {value.map((item, idx) => (
          <div class="rounded-lg border bg-white p-3" data-path={`${path}[${idx}]`}>
            <div class="text-xs font-semibold text-gray-500 mb-2">Item {idx + 1}</div>
            {renderValue(item, `${path}[${idx}]`)}
          </div>
        ))}
      </div>
    );
  }

  // Objects
  if (isRecord(value)) {
    const entries = Object.entries(value);
    if (entries.length === 0) {
      return <span class="text-gray-400">{`{}`}</span>;
    }

    return (
      <dl class="grid gap-3">
        {entries.map(([k, v]) => (
          <div class="rounded-lg border bg-gray-50 p-3" data-path={`${path}.${k}`}>
            <dt class="text-xs font-semibold text-gray-600">{prettyKey(k)}</dt>
            <dd class="mt-1 text-sm text-gray-900">
              {renderValue(v, `${path}.${k}`)}
            </dd>
          </div>
        ))}
      </dl>
    );
  }

  // Primitives
  if (value === "") return <span class="text-gray-400">(vacío)</span>;
  if (value === null) return <span class="text-gray-400">null</span>;
  if (value === undefined) return <span class="text-gray-400">undefined</span>;

  return <span class="break-words">{String(value)}</span>;
}
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" href="/favicon.svg" type="image/x-icon" />
  </head>

  <body class="bg-white text-gray-900" style={cssVars}>
    <main class="container mx-auto px-4 py-10 max-w-4xl">
      <header class="mb-8">
        <h1 class="text-3xl font-bold">{title}</h1>
        {content?.profile?.headline && (
          <p class="mt-2 text-lg text-gray-700">{content.profile.headline}</p>
        )}
        {description && <p class="mt-2 text-gray-600">{description}</p>}
      </header>
 
      <section class="rounded-2xl border bg-white p-5 shadow-sm">
        <h2 class="text-xl font-semibold mb-4">Estructura del contenido (JSON)</h2>
        {renderValue(content, "root")}
      </section>
    </main>
  </body>
</html>
