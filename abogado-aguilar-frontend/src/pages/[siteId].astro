---
export const prerender = false;

import "../styles/global.css";
import { fetchContent } from "../lib/api";
import type { SiteContent } from "../types";

const { siteId } = Astro.params;
const id = String(siteId ?? "");

// Trae contenido
let content: SiteContent | null = null;
try {
  content = await fetchContent(id);
} catch {
  return Astro.redirect("/404");
}

// Si tu fetchContent devuelve {} en 404, esto lo detecta
if (!content || Object.keys(content as any).length === 0) {
  return Astro.redirect("/404");
}

const title = (content as any)?.profile?.fullName ?? id;
const description = (content as any)?.seo?.description ?? "";

// Helpers
const isRecord = (v: unknown): v is Record<string, unknown> =>
  typeof v === "object" && v !== null && !Array.isArray(v);

const typeLabel = (v: unknown) => {
  if (Array.isArray(v)) return `array(${v.length})`;
  if (isRecord(v)) return "object";
  return typeof v; // string | number | boolean | undefined | ...
};

// Render recursivo (campos, no valores)
const renderValue = (value: unknown, path: string): any => {
  // Arrays
  if (Array.isArray(value)) {
    if (value.length === 0) {
      return <span class="text-xs text-gray-500 italic">array vacío</span>;
    }

    return (
      <ul class="mt-2 space-y-2">
        {value.map((item, idx) => {
          const nextPath = `${path}[${idx}]`;
          return (
            <li
              class="rounded-lg border border-gray-200 bg-white p-3"
              data-path={nextPath}
            >
              <div class="text-xs font-semibold text-gray-600">
                {`[${idx}]`} <span class="ml-1 font-normal text-gray-400">({typeLabel(item)})</span>
              </div>
              <div class="mt-2">{renderValue(item, nextPath)}</div>
            </li>
          );
        })}
      </ul>
    );
  }

  // Objetos
  if (isRecord(value)) {
    const entries = Object.entries(value);
    if (entries.length === 0) {
      return <span class="text-xs text-gray-500 italic">objeto vacío</span>;
    }

    return (
      <dl class="mt-2 grid gap-3 sm:grid-cols-2">
        {entries.map(([k, v]) => {
          const nextPath = path ? `${path}.${k}` : k;
          return (
            <div
              class="rounded-lg border border-gray-200 bg-gray-50 p-3"
              data-path={nextPath}
            >
              <dt class="text-xs font-semibold text-gray-700">
                {k} <span class="ml-1 font-normal text-gray-400">({typeLabel(v)})</span>
              </dt>
              <dd class="mt-2">
                {isRecord(v) || Array.isArray(v) ? (
                  renderValue(v, nextPath)
                ) : (
                  <span class="text-xs text-gray-500 italic">campo primitivo</span>
                )}
              </dd>
            </div>
          );
        })}
      </dl>
    );
  }

  // Primitivos (no te interesan valores, solo el campo)
  return <span class="text-xs text-gray-500 italic">campo primitivo</span>;
};
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" href="/favicon.svg" type="image/x-icon" />
  </head>

  <body class="bg-white text-gray-900">
    <main class="container mx-auto px-4 py-8">
      <header class="mb-6">
        <h1 class="text-3xl font-bold">{title}</h1>
        {description && <p class="mt-2 text-gray-600">{description}</p>}
        <p class="mt-2 text-sm text-gray-500">
          Sitio: <span class="font-mono">{id}</span>
        </p>
      </header>

      <section class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
        <h2 class="text-lg font-semibold">Estructura completa del contenido (campos)</h2>
        <p class="mt-1 text-sm text-gray-600">
          Se muestran los campos y su tipo. No se muestran valores.
        </p>

        <div class="mt-4">
          {renderValue(content as any, "root")}
        </div>
      </section>
    </main>
  </body>
</html>
