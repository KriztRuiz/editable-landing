---
export const prerender = false;

import "../styles/global.css";
import { fetchContent, buildWhatsAppUrl } from "../lib/api";
import type { SiteContent } from "../types";

const { siteId } = Astro.params;
const id = String(siteId ?? "");

// Evita que se cachee el HTML SSR en el edge/CDN (si algún día agregas caching)
Astro.response.headers.set("Cache-Control", "no-store");

const url = new URL(Astro.request.url);
const debug = url.searchParams.get("debug") === "1";

let content: SiteContent;
try {
  content = await fetchContent(id);
} catch (e) {
  console.error("[siteId] fetchContent error:", e);
  return Astro.redirect("/404");
}

if (!content || Object.keys(content as any).length === 0) {
  return Astro.redirect("/404");
}

const title = content?.seo?.title || content?.profile?.fullName || id;
const description = content?.seo?.description || "";

const colors = content?.theme?.colors || {
  primary: "#0f172a",
  secondary: "#1e293b",
  background: "#ffffff",
  text: "#0b0b0b",
};

const cssVars =
  `--p:${colors.primary};--s:${colors.secondary || colors.primary};--bg:${colors.background};--t:${colors.text};`;

const logo = content?.profile?.photoUrl || content?.theme?.logoUrl || "";
const preferred = content?.cta?.preferred || "whatsapp";

const whatsappHref =
  content?.contact?.whatsapp
    ? buildWhatsAppUrl(
        content.contact.whatsapp,
        content?.cta?.whatsappMessage || `Hola, vengo del sitio ${title}`
      )
    : "";

const phoneHref =
  content?.contact?.phone ? `tel:${content.contact.phone}` : "";

const bookingHref = content?.cta?.bookingUrl || "";
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" href="/favicon.svg" type="image/x-icon" />
  </head>

  <body style={cssVars} class="min-h-screen bg-[var(--bg)] text-[var(--t)]">
    <main class="mx-auto max-w-5xl px-4 py-8">
      {/* HEADER */}
      <header class="flex items-center gap-4 rounded-2xl border border-black/10 bg-white p-5 shadow-sm">
        {logo ? (
          <img
            src={logo}
            alt={`Logo de ${title}`}
            width="72"
            height="72"
            loading="lazy"
            class="h-[72px] w-[72px] rounded-full object-cover"
          />
        ) : (
          <div class="h-[72px] w-[72px] rounded-full bg-black/10" />
        )}

        <div class="flex-1">
          <h1 class="text-3xl font-bold">{content.profile.fullName}</h1>
          {content.profile.headline ? (
            <p class="mt-1 text-black/60">{content.profile.headline}</p>
          ) : null}
        </div>

        {/* CTA */}
        <div class="flex flex-col gap-2">
          {preferred === "whatsapp" && whatsappHref ? (
            <a
              class="rounded-xl px-4 py-2 text-center font-semibold text-white"
              style="background:var(--p)"
              href={whatsappHref}
              target="_blank"
              rel="noreferrer"
            >
              WhatsApp
            </a>
          ) : null}

          {preferred === "call" && phoneHref ? (
            <a
              class="rounded-xl px-4 py-2 text-center font-semibold text-white"
              style="background:var(--p)"
              href={phoneHref}
            >
              Llamar
            </a>
          ) : null}

          {preferred === "agenda" && bookingHref ? (
            <a
              class="rounded-xl px-4 py-2 text-center font-semibold text-white"
              style="background:var(--p)"
              href={bookingHref}
              target="_blank"
              rel="noreferrer"
            >
              Agendar
            </a>
          ) : null}
        </div>
      </header>

      {/* TOP GRID */}
      <section class="mt-6 grid gap-4 md:grid-cols-2">
        <div class="rounded-2xl border border-black/10 bg-white p-5 shadow-sm">
          <h2 class="text-lg font-semibold">Acerca de</h2>
          <p class="mt-3 text-black/70">
            {content.profile.intro?.trim() ? content.profile.intro : "—"}
          </p>
        </div>

        <div class="rounded-2xl border border-black/10 bg-white p-5 shadow-sm">
          <h2 class="text-lg font-semibold">Contacto</h2>
          <ul class="mt-3 space-y-2 text-black/70">
            {content.contact.email ? (
              <li>
                <a class="underline" href={`mailto:${content.contact.email}`}>
                  {content.contact.email}
                </a>
              </li>
            ) : null}

            {content.contact.phone ? (
              <li>
                <a class="underline" href={phoneHref}>
                  {content.contact.phone}
                </a>
              </li>
            ) : null}

            {content.contact.whatsapp ? (
              <li>
                <a class="underline" href={whatsappHref} target="_blank" rel="noreferrer">
                  {content.contact.whatsapp}
                </a>
              </li>
            ) : null}

            {content.contact.address ? <li>{content.contact.address}</li> : null}
          </ul>
        </div>
      </section>

      {/* ESPECIALIDADES */}
      {content.sections?.showAreas ? (
        <section class="mt-6 rounded-2xl border border-black/10 bg-white p-5 shadow-sm">
          <h2 class="text-lg font-semibold">Especialidades</h2>

          {content.specialties?.length ? (
            <ul class="mt-3 grid gap-3 md:grid-cols-2">
              {content.specialties.map((s) => (
                <li class="rounded-xl border border-black/10 bg-white p-4">
                  <div class="font-semibold">{s.name}</div>
                  {s.description ? <div class="mt-1 text-black/70">{s.description}</div> : null}
                </li>
              ))}
            </ul>
          ) : (
            <p class="mt-3 text-black/60">Sin registros.</p>
          )}
        </section>
      ) : null}

      {/* SERVICIOS */}
      {content.sections?.showServices ? (
        <section class="mt-6 rounded-2xl border border-black/10 bg-white p-5 shadow-sm">
          <h2 class="text-lg font-semibold">Servicios</h2>

          {content.services?.length ? (
            <ul class="mt-3 grid gap-3 md:grid-cols-2">
              {content.services.map((sv) => (
                <li class="rounded-xl border border-black/10 bg-white p-4">
                  <div class="font-semibold">{sv.name}</div>
                  {sv.description ? <div class="mt-1 text-black/70">{sv.description}</div> : null}
                  {(sv.priceMin != null || sv.priceMax != null) ? (
                    <div class="mt-2 text-sm text-black/60">
                      {sv.priceMin != null ? `Desde $${sv.priceMin}` : ""}
                      {sv.priceMax != null ? ` · Hasta $${sv.priceMax}` : ""}
                    </div>
                  ) : null}
                </li>
              ))}
            </ul>
          ) : (
            <p class="mt-3 text-black/60">Sin registros.</p>
          )}
        </section>
      ) : null}

      {/* FAQS */}
      {content.sections?.showFaqs ? (
        <section class="mt-6 rounded-2xl border border-black/10 bg-white p-5 shadow-sm">
          <h2 class="text-lg font-semibold">FAQs</h2>

          {content.faqs?.length ? (
            <div class="mt-3 space-y-3">
              {content.faqs.map((f) => (
                <details class="rounded-xl border border-black/10 bg-white p-4">
                  <summary class="cursor-pointer font-semibold">{f.q}</summary>
                  <p class="mt-2 text-black/70">{f.a}</p>
                </details>
              ))}
            </div>
          ) : (
            <p class="mt-3 text-black/60">Sin registros.</p>
          )}
        </section>
      ) : null}

      {/* TESTIMONIOS */}
      {content.sections?.showTestimonials ? (
        <section class="mt-6 rounded-2xl border border-black/10 bg-white p-5 shadow-sm">
          <h2 class="text-lg font-semibold">Testimonios</h2>

          {content.testimonials?.length ? (
            <ul class="mt-3 grid gap-3 md:grid-cols-2">
              {content.testimonials.map((t) => (
                <li class="rounded-xl border border-black/10 bg-white p-4">
                  <div class="font-semibold">{t.author}</div>
                  {t.rating != null ? <div class="text-sm text-black/60">⭐ {t.rating}/5</div> : null}
                  <p class="mt-2 text-black/70">{t.text}</p>
                </li>
              ))}
            </ul>
          ) : (
            <p class="mt-3 text-black/60">Sin registros.</p>
          )}
        </section>
      ) : null}

      {/* HORARIO */}
      {content.schedule?.length ? (
        <section class="mt-6 rounded-2xl border border-black/10 bg-white p-5 shadow-sm">
          <h2 class="text-lg font-semibold">Horario</h2>
          <ul class="mt-3 space-y-2 text-black/70">
            {content.schedule.map((h) => (
              <li class="rounded-xl border border-black/10 bg-white p-3">
                <span class="font-semibold">{h.days}</span>: {h.open} – {h.close}
              </li>
            ))}
          </ul>
        </section>
      ) : null}

      {/* DEBUG: JSON crudo */}
      {debug ? (
        <section class="mt-6 rounded-2xl border border-black/10 bg-white p-5 shadow-sm">
          <h2 class="text-lg font-semibold">DEBUG: JSON recibido del backend</h2>
          <pre class="mt-3 overflow-auto rounded-xl bg-black/5 p-4 text-xs">
{JSON.stringify(content, null, 2)}
          </pre>
        </section>
      ) : null}
    </main>
  </body>
</html>
