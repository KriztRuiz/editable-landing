---
export const prerender = false;

import "../styles/global.css";
import { fetchContent } from "../lib/api";
import type { SiteContent } from "../types";

const { siteId } = Astro.params;
const id = String(siteId ?? "");

// 1) Cargar contenido
let content: SiteContent | null = null;

try {
  content = await fetchContent(id);
} catch {
  return Astro.redirect("/404");
}

// Si tu fetchContent devuelve {} cuando no existe, esto lo manda a 404 también
if (!content || !("siteId" in (content as any)) || !(content as any).siteId) {
  return Astro.redirect("/404");
}

const title = content?.profile?.fullName ?? id;
const headline = content?.profile?.headline ?? "";
const description = content?.seo?.description ?? "";

// Helpers
const isPlainObject = (v: unknown): v is Record<string, any> =>
  v !== null && typeof v === "object" && !Array.isArray(v);

const prettyKey = (k: string) =>
  k
    .replace(/^_+/, "")
    .replace(/([a-z0-9])([A-Z])/g, "$1 $2")
    .replace(/[-_]+/g, " ")
    .trim()
    .replace(/^./, (c) => c.toUpperCase());

function renderValue(value: any, basePath = "root"): any {
  // Arrays
  if (Array.isArray(value)) {
    if (value.length === 0) {
      return <p class="text-sm text-gray-500">(vacío)</p>;
    }
    return (
      <ul class="space-y-2">
        {value.map((item, idx) => (
          <li class="rounded-lg border bg-white p-3" data-path={`${basePath}[${idx}]`}>
            {renderValue(item, `${basePath}[${idx}]`)}
          </li>
        ))}
      </ul>
    );
  }

  // Objects
  if (isPlainObject(value)) {
    const entries = Object.entries(value);
    if (entries.length === 0) {
      return <p class="text-sm text-gray-500">(objeto vacío)</p>;
    }

    return (
      <dl class="space-y-3">
        {entries.map(([k, v]) => (
          <div class="rounded-lg bg-gray-50 p-3 border" data-path={`${basePath}.${k}`}>
            <dt class="text-xs font-semibold uppercase tracking-wide text-gray-600">
              {prettyKey(k)}
            </dt>
            <dd class="mt-2">
              {renderValue(v, `${basePath}.${k}`)}
            </dd>
          </div>
        ))}
      </dl>
    );
  }

  // Primitives
  if (value === "" || value === null || value === undefined) {
    return <span class="text-sm text-gray-500">(vacío)</span>;
  }

  return <span class="text-sm text-gray-900">{String(value)}</span>;
}
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" href="/favicon.svg" type="image/x-icon" />
  </head>

  <body class="bg-white text-gray-900">
    <main class="container mx-auto px-4 py-8">
      <header class="mb-8">
        <h1 class="text-3xl font-bold">{title}</h1>
        {headline && <p class="text-lg text-gray-700 mt-1">{headline}</p>}
        {description && <p class="text-gray-700 mt-3 max-w-2xl">{description}</p>}
      </header>

      <section class="grid gap-6 md:grid-cols-2">
        <article class="rounded-2xl border p-5">
          <h2 class="text-lg font-semibold mb-3">Identidad</h2>
          {renderValue({ _id: (content as any)._id, siteId: (content as any).siteId, __v: (content as any).__v }, "identity")}
        </article>

        <article class="rounded-2xl border p-5">
          <h2 class="text-lg font-semibold mb-3">Perfil</h2>
          {renderValue(content.profile, "profile")}
        </article>

        <article class="rounded-2xl border p-5">
          <h2 class="text-lg font-semibold mb-3">Contacto</h2>
          {renderValue(content.contact, "contact")}
        </article>

        <article class="rounded-2xl border p-5">
          <h2 class="text-lg font-semibold mb-3">CTA</h2>
          {renderValue(content.cta, "cta")}
        </article>

        <article class="rounded-2xl border p-5">
          <h2 class="text-lg font-semibold mb-3">SEO</h2>
          {renderValue(content.seo, "seo")}
        </article>

        <article class="rounded-2xl border p-5">
          <h2 class="text-lg font-semibold mb-3">Tema</h2>
          {renderValue(content.theme, "theme")}
        </article>

        <article class="rounded-2xl border p-5">
          <h2 class="text-lg font-semibold mb-3">Settings</h2>
          {renderValue(content.settings, "settings")}
        </article>

        <article class="rounded-2xl border p-5">
          <h2 class="text-lg font-semibold mb-3">Secciones</h2>
          {renderValue(content.sections, "sections")}
        </article>

        <article class="rounded-2xl border p-5 md:col-span-2">
          <h2 class="text-lg font-semibold mb-3">Especialidades</h2>
          {renderValue(content.specialties, "specialties")}
        </article>

        <article class="rounded-2xl border p-5 md:col-span-2">
          <h2 class="text-lg font-semibold mb-3">Servicios</h2>
          {renderValue(content.services, "services")}
        </article>

        <article class="rounded-2xl border p-5 md:col-span-2">
          <h2 class="text-lg font-semibold mb-3">FAQs</h2>
          {renderValue(content.faqs, "faqs")}
        </article>

        <article class="rounded-2xl border p-5 md:col-span-2">
          <h2 class="text-lg font-semibold mb-3">Testimonios</h2>
          {renderValue(content.testimonials, "testimonials")}
        </article>

        <article class="rounded-2xl border p-5 md:col-span-2">
          <h2 class="text-lg font-semibold mb-3">Horario</h2>
          {renderValue(content.schedule, "schedule")}
        </article>

        <article class="rounded-2xl border p-5 md:col-span-2">
          <h2 class="text-lg font-semibold mb-3">Fechas</h2>
          {renderValue({ createdAt: (content as any).createdAt, updatedAt: (content as any).updatedAt }, "dates")}
        </article>
      </section>
    </main>
  </body>
</html>
